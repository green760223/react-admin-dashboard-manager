import{d as P,u as _,j as e,B as x,F as a,r as d,a as f,I as h,s as V,L as B,P as q,m as o,S as D,e as z}from"./index-20e9fe8d.js";import{u as K}from"./index-8a8f6a6d.js";import{a as M}from"./roleApi-829441e0.js";import{M as N}from"./index-b7ce58c4.js";import{_ as A}from"./index-81b5abb8.js";import{S as i}from"./index-6bbec992.js";import{_ as G}from"./index-c5856605.js";import{T as H}from"./Table-1d5dd19f.js";import"./useBreakpoint-9dd5e0e1.js";function J(r){const l=P("layout"),c=_(u=>u.userInfo.role);return r.auth?l.buttonList.includes(r.auth)||c==1?e.jsx(x,{...r,children:r.children}):e.jsx("div",{}):e.jsx(x,{...r,children:r.children})}const $=r=>{const[l]=a.useForm(),[c,u]=d.useState(""),[L,g]=d.useState(!1),[p,I]=d.useState(!1),[j,k]=d.useState("create"),[b,C]=d.useState([]),[S,s]=d.useState([]);d.useEffect(()=>{m(),w()},[]);const m=async()=>{const t=await f.getDeptList();C(t)},w=async()=>{const t=await M.getAllRoleList();s(t)};d.useImperativeHandle(r.mRef,()=>({open:y}));const y=(t,n)=>{I(!0),k(t),t==="edit"&&n&&(l.setFieldsValue(n),u(n.userImg))},U=async()=>{if(await l.validateFields()){const n={...l.getFieldsValue(),userImg:c};j==="create"?(await f.createUser(n),o.success("創建成功")):(await f.editUser(n),o.success("更新成功")),O(),r.update()}},O=()=>{I(!1),u(""),l.resetFields()},F=t=>{const n=t.type==="image/jpeg"||t.type==="image/png";if(!n)return o.error("只能上傳JPG/PNG格式的圖片"),!1;const v=t.size/1024/1024<.5;return v||o.error("圖片大小不能超過500KB"),n&&v},R=t=>{if(t.file.status==="uploading"){g(!0);return}if(t.file.status==="done"){g(!1);const{code:n,data:v,msg:E}=t.file.response;n===0?u(v.file):o.error(E)}else t.file.status==="error"&&o.error("伺服器異常，請稍後重試")},T=t=>(console.log("Upload event:",t),Array.isArray(t)?t:t&&t.fileList);return e.jsx(N,{title:j==="create"?"創建用戶":"編輯用戶",width:800,open:p,onOk:U,onCancel:O,okText:"確定",cancelText:"取消",children:e.jsxs(a,{form:l,labelCol:{span:4},labelAlign:"right",children:[e.jsx(a.Item,{name:"userId",hidden:!0,children:e.jsx(h,{})}),e.jsx(a.Item,{label:"用戶名稱",name:"userName",rules:[{required:!0,message:"請輸入用戶名稱"},{min:3,max:12,message:"用戶名稱最小3個字符，最大12字符"}],children:e.jsx(h,{placeholder:"請輸入用戶名稱"})}),e.jsx(a.Item,{label:"用戶信箱",name:"userEmail",rules:[{required:!0,message:"請輸入用戶信箱"},{type:"email",message:"請輸入正確的信箱格式"},{pattern:/^\w+@mars.com$/,message:"請輸入格式為mars.com結尾的信箱"}],children:e.jsx(h,{placeholder:"請輸入用戶信箱",disabled:j==="edit"})}),e.jsx(a.Item,{label:"手機",name:"mobile",rules:[{len:11,message:"請輸入11位手機號"},{pattern:/1[1-9]\d{9}/,message:"請輸入為1開頭的手機號"}],children:e.jsx(h,{type:"number",placeholder:"請輸入手機"})}),e.jsx(a.Item,{label:"部門",name:"deptId",rules:[{required:!0,message:"請選擇部門"}],children:e.jsx(A,{placeholder:"請選擇部門",allowClear:!0,treeDefaultExpandAll:!0,showCheckedStrategy:A.SHOW_ALL,treeData:b,fieldNames:{label:"deptName",value:"_id"}})}),e.jsx(a.Item,{label:"崗位",name:"job",children:e.jsx(h,{placeholder:"請輸入崗位"})}),e.jsx(a.Item,{label:"狀態",name:"state",children:e.jsxs(i,{children:[e.jsx(i.Option,{value:1,children:"在職"}),e.jsx(i.Option,{value:2,children:"離職"}),e.jsx(i.Option,{value:3,children:"試用期"})]})}),e.jsx(a.Item,{label:"系統角色",name:"roleList",children:e.jsx(i,{placeholder:"請選擇角色",children:S.map(t=>e.jsx(i.Option,{value:t._id,children:t.roleName},t._id))})}),e.jsx(a.Item,{label:"用戶頭像",name:"profile",valuePropName:"fileList",getValueFromEvent:T,children:e.jsx(G,{listType:"picture-circle",showUploadList:!1,action:"/api/users/upload",beforeUpload:F,onChange:R,headers:{Authorization:"Bearer "+V.get("token"),icode:"775A5C5953C9AEC2"},children:c?e.jsx("img",{src:c,alt:"avatar",style:{width:"100%",borderRadius:"100%"}}):e.jsxs("div",{children:[L?e.jsx(B,{}):e.jsx(q,{}),e.jsx("div",{style:{marginTop:8},children:"上傳頭像"})]})})})]})})};function W(r){return e.jsxs(a,{className:"search-form",form:r.form,layout:"inline",initialValues:r.initialValues,children:[r.children,e.jsx(a.Item,{children:e.jsxs(D,{children:[e.jsx(x,{type:"primary",onClick:r.submit,children:"搜索"}),e.jsx(x,{type:"default",onClick:r.reset,children:"重置"})]})})]})}function le(){const[r]=a.useForm(),l=d.useRef(),[c,u]=d.useState([]),L=({current:s,pageSize:m},w)=>f.getUserList({...w,pageNum:s,pageSize:m}).then(y=>({list:y.list,total:y.page.total})),{tableProps:g,search:p}=K(L,{form:r,defaultPageSize:10}),I=()=>{var s;(s=l.current)==null||s.open("create")},j=s=>{var m;(m=l.current)==null||m.open("edit",s)},k=s=>{N.confirm({title:"刪除確認",content:e.jsx("span",{children:"確認刪除該用戶嗎？"}),onOk:()=>{b([s])}})},b=async s=>{try{await f.delUser({userIds:s}),o.success("刪除成功"),u([]),p.reset()}catch{o.error("刪除失敗")}},C=()=>{if(c.length===0){o.error("請選擇需要刪除的用戶");return}N.confirm({title:"刪除確認",content:e.jsx("span",{children:"確認刪除該批用戶嗎？"}),onOk:()=>{b(c)}})},S=[{title:"用戶ID",dataIndex:"userId",key:"userId"},{title:"用戶名稱",dataIndex:"userName",key:"userName"},{title:"用戶信箱",dataIndex:"userEmail",key:"userEmail"},{title:"用戶角色",dataIndex:"address",key:"address",render(s){return{0:"超級管理員",1:"管理員",2:"體驗管理員",3:"普通用戶"}[s]}},{title:"用戶狀態",dataIndex:"state",key:"state",render(s){return{1:"在職",2:"離職",3:"試用期"}[s]}},{title:"註冊時間",dataIndex:"createTime",key:"createTime",render(s){return z(s)}},{title:"操作",key:"address",render(s){return e.jsxs(D,{children:[e.jsx(x,{type:"text",onClick:()=>j(s),children:"編輯"}),e.jsx(x,{type:"text",danger:!0,onClick:()=>k(s.userId),children:"刪除"})]})}}];return e.jsxs("div",{className:"user-list",children:[e.jsxs(W,{form:r,initialValues:{state:1},submit:p.submit,reset:p.reset,children:[e.jsx(a.Item,{name:"userId",label:"用戶ID",children:e.jsx(h,{placeholder:"請輸入用戶ID"})}),e.jsx(a.Item,{name:"userName",label:"用戶名稱",children:e.jsx(h,{placeholder:"請輸入用戶名稱"})}),e.jsx(a.Item,{name:"state",label:"狀態",children:e.jsxs(i,{style:{width:120},children:[e.jsx(i.Option,{value:0,children:"所有"}),e.jsx(i.Option,{value:1,children:"在職"}),e.jsx(i.Option,{value:2,children:"離職"}),e.jsx(i.Option,{value:3,children:"試用期"})]})})]}),e.jsxs("div",{className:"base-table",children:[e.jsxs("div",{className:"header-wrapper",children:[e.jsx("div",{className:"title",children:"用戶列表"}),e.jsxs("div",{className:"action",children:[e.jsx(J,{auth:"user@create",type:"primary",onClick:I,children:"新增"}),e.jsx(x,{type:"primary",danger:!0,onClick:C,children:"批量刪除"})]})]}),e.jsx(H,{bordered:!0,rowKey:"userId",rowSelection:{type:"checkbox",selectedRowKeys:c,onChange:s=>{u(s)}},columns:S,...g})]}),e.jsx($,{mRef:l,update:()=>{p.reset()}})]})}export{le as default};
